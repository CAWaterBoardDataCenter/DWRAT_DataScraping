# Load libraries----
library(readxl)
library(dplyr)

# Import data----

#Pick your watershed and reporting timeframe
source("Scripts/Watershed_Selection.R")
source("Scripts/Dataset_Year_Range.R")

#Import the manual review spreadsheet with missing reports pertaining to your watershed
manual_review = getXLSX(ws = ws, 
        SHAREPOINT_BOOL = "IS_SHAREPOINT_PATH_NA_REPORTS_SPREADSHEET",
         FILEPATH = "NA_REPORTS_SPREADSHEET_PATH", 
         WORKSHEET_NAME = "NA_REPORTS_WORKSHEET_NAME"	)

# Manual review spreadsheet tells you which records 
#1) Should be deleted from Statistics_Final OR
#2) Whose reporting values should be converted to zeroes


# Statistics_Final is generated by running a subset of the demand scripts on GitHub; outputted by
# the Priority_Date_Postprocessing.R script; only contains calendar year information, but includes 3
# sets of manual reviews:

  #GIS_Preprocessing
  #Unit conversion corrections
  #Duplicate reporting corrections

Statistics_Final <- read.csv(paste0("IntermediateData/", ws$ID, "_", yearRange[1], "_", 
yearRange[2], "_Statistics_FINAL.csv"))

# Analyzing the manual review spreadsheet----

manual_review_true = manual_review %>% filter(REPLACE_NA_VALUES_WITH_ZEROS == TRUE)
manual_review_false = manual_review %>% filter(REPLACE_NA_VALUES_WITH_ZEROS == FALSE)

#Comments below pertain only to the Russian River, analysis conducted by Payman Alemi and Aakash Prashar on 5/2/2024

# 74 monthly records where there IS NO associated monthly report in eWRIMS because the 
# water year report was not submitted but data exists for the portion of the calendar year that 
# overlaps with the water year; this would occur if a diverter reported a diversion in October 2021, 
# submitted that on the 2022 water year report but submitted no 2021 water year report at all. So water year 2021 
# doesn't exist but calendar year 2021 has data! These 74 records fall into that camp and it's an attempt
#to remove records that would mistakenly be tied to the wrong water year. REPORT_LINK is NA for all 74 records so we can 
#eliminate them from Statistics_Final.csv

#Water Year Child Table, begins when YEAR >= 2022
manual_review_false_wy = manual_review_false %>% filter(YEAR >= 2022)
manual_review_false_wy = manual_review_false_wy %>% rename("water_year" = "YEAR")

#Add a primary key
manual_review_false_wy = manual_review_false_wy %>%mutate(pk_wy = paste0(APPLICATION_NUMBER, "_", "water_year"))

#Calendar Year Child Table, for 2021 and earlier
manual_review_false_cy = manual_review_false %>% filter(YEAR < 2022)
manual_review_false_cy = manual_review_false_cy %>% rename("calendar_year" = "YEAR")

#Add a primary key
manual_review_false_cy = manual_review_false_cy %>%mutate(pk_cy = paste0(APPLICATION_NUMBER, "_", "calendar_year"))


# Construct an index to convert calendar year to water year for Statistics_Final
Statistics_Final = Statistics_Final %>% rename("calendar_year" = "YEAR")
Statistics_Final = Statistics_Final %>%
  mutate(water_year = ifelse(MONTH < 10, calendar_year, calendar_year+1))

#Eliminate overlapping records between manual_review_false and Statistics_Final
# Add the water year primary key to Statistics_Final
Statistics_Final = Statistics_Final %>% mutate(pk_wy = paste0(APPLICATION_NUMBER,"_", water_year))

# Add the calendar year primary key to Statistics_Final
Statistics_Final = Statistics_Final %>% mutate(pk_cy = paste0(APPLICATION_NUMBER,"_", calendar_year))

# Anti-join Statistics_Final to manual_review false_wy based on the pk_wy field; 
Statistics_Final2 = anti_join(x = Statistics_Final, y = manual_review_false_wy, by = "pk_wy")
# Doesn't eliminate any records

#Anti-join Statistics_Final2 to manual_review_false_cy based on the pk_cy field
Statistics_Final3 = anti_join(x = Statistics_Final, y = manual_review_false_cy, by = "pk_cy")
#Doesn't eliminate any records

#Remove Statistics_Final2 and Statistics_Final3
rm(Statistics_Final2, Statistics_Final3)

  #Split the manual_review_true dataframe into 2 components to account for transition from calendar year to water year
  # 2022 is the first water year, which took effect in October 2021 (calendar time)
  # All 2022- records should be placed in a manual_review_wy (WY = Water Year) dataframe
  # All <2022 records should be placed in a manual_review_cy (CY = Calendar Year) dataframe

manual_review_true_wy = manual_review_true %>% filter(YEAR >= 2022)
manual_review_true_wy = manual_review_true_wy %>% rename("water_year" = "YEAR")
#this dataframe is empty because all the water usage reports with missing monthly values occurred
# prior to water year 2022; latest report with missing monthly values occurred in calendar year 2019

manual_review_true_cy = manual_review_true %>% filter(YEAR < 2022)
manual_review_true_cy = manual_review_true_cy %>% rename("calendar_year" = "YEAR")
# Contains all the water usage reports with missing monthly values; 8 reports


# Add records to Statistics_Final that correspond to the  pk_cy values in manual_review_true_cy
Statistics_Final2 = Statistics_Final

for (i in 1:nrow(manual_review_true_cy)){
  Shell = data.frame("APPLICATION_NUMBER" = manual_review_true_cy$APPLICATION_NUMBER[i],
                     "calendar_year" = manual_review_true_cy$calendar_year[i],
                     "MONTH" = rep(1:12,2),
                     "AMOUNT" = rep(0, 24),
                     "DIVERSION_TYPE" = c(rep("STORAGE", 12), rep("DIRECT", 12))) %>%
  
  mutate(water_year = ifelse(MONTH < 10, calendar_year, calendar_year+1)) %>%
  mutate(pk_wy = paste0(APPLICATION_NUMBER, "_", water_year))%>%
  mutate(pk_cy = paste0(APPLICATION_NUMBER, "_", calendar_year))
  Statistics_Final2 = rbind(Statistics_Final2, Shell)     
}
     
# Filter out DIVERSION_TYPE = "USE"
Statistics_Final2 = Statistics_Final2 %>% filter(DIVERSION_TYPE != "USE")

#Export Statistics_Final2 as a CSV
write.csv(x = Statistics_Final2, file = paste0("OutputData/",
ws$ID, "_", yearRange[1], "_", yearRange[2], "_Monthly_Demands_By_Right.csv"),
row.names= F)

